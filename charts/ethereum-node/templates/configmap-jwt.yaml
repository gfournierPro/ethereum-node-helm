{{- if .Values.executionLayer.enabled }}
{{- if .Values.consensusLayer.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "ethereum-node.fullname" . }}-jwt
  labels:
    {{- include "ethereum-node.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": keep  # ‚Üê Prevent deletion on uninstall
type: Opaque
stringData:
  {{- if .Values.jwt.token }}
  # Use provided JWT token
  jwt.hex: {{ .Values.jwt.token | quote }}
  {{- else }}
  # Generate JWT token only if not exists
  # This will be kept across upgrades due to lookup
  jwt.hex: {{ (lookup "v1" "Secret" .Release.Namespace (printf "%s-jwt" (include "ethereum-node.fullname" .))) | ternary ((lookup "v1" "Secret" .Release.Namespace (printf "%s-jwt" (include "ethereum-node.fullname" .))).data.jwt.hex | b64dec) (randAlphaNum 64 | sha256sum) | quote }}
  {{- end }}
{{- end }}
{{- end }}