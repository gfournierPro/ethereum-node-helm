{{- if .Values.executionLayer.enabled }}
{{- if .Values.consensusLayer.enabled }}
{{- if not .Values.jwt.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "ethereum-node.fullname" . }}-jwt
  labels:
    {{- include "ethereum-node.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
stringData:
  {{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace (printf "%s-jwt" (include "ethereum-node.fullname" .))) }}
  {{- if $existingSecret }}
  # Use existing JWT token
  jwt.hex: {{ index $existingSecret.data "jwt.hex" | b64dec | quote }}
  {{- else if .Values.jwt.token }}
  # Use provided JWT token
  jwt.hex: {{ .Values.jwt.token | quote }}
  {{- else }}
  # Generate new JWT token (64 hex chars = 32 bytes)
  jwt.hex: {{ randAlphaNum 32 | sha256sum | trunc 64 | quote }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}
